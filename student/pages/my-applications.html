<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Immediately apply dark mode if saved (prevents flash) -->
    <script>
        // Check for saved dark mode preference and apply it immediately
        if (localStorage.getItem('darkMode') === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <script>
    // Apply student type immediately to prevent flash
    (function() {
        const userType = localStorage.getItem('userType');
        if (userType) {
            document.body.classList.add('is-' + userType);
        }
    })();
    </script>
    
    <!-- Auth Guard Script - MOVED TO HEAD TO LOAD EARLY -->
    <script src="../js/auth-guard.js"></script>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Common Tailwind configuration -->
    <script src="../js/tailwind-config.js"></script>
    
    <!-- Common CSS variables -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="icon" href="../images/favicon.svg" type="image/svg+xml">
    <title>My Applications - Student Event Platform</title>
</head>
<body class="bg-dashboard-bg text-dashboard-text dark:bg-dashboard-bg dark:text-dashboard-text" 
      data-auth-required="true" 
      data-roles="student">
    
    <!-- Header will be loaded here -->
    <div id="header-placeholder"></div>

    <main class="pt-20 pb-16 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8">
                <div>
                    <h1 class="text-3xl font-bold">My Applications</h1>
                    <p class="text-dashboard-text-secondary mt-1">Track the status of your job applications</p>
                </div>
                <a href="job-offers.html" class="bg-theme-primary text-white rounded-lg px-4 py-2 font-medium hover:bg-theme-primary-hover transition flex items-center justify-center sm:justify-start">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Browse Job Offers
                </a>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white dark:bg-dashboard-card-bg rounded-lg shadow-sm p-4 border border-dashboard-border dark:border-dashboard-border">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-dashboard-text-secondary text-sm">Total Applications</p>
                            <h3 id="total-count" class="text-2xl font-bold">0</h3>
                        </div>
                        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                            <svg class="w-6 h-6 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dashboard-card-bg rounded-lg shadow-sm p-4 border border-dashboard-border dark:border-dashboard-border">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-dashboard-text-secondary text-sm">In Progress</p>
                            <h3 id="progress-count" class="text-2xl font-bold">0</h3>
                        </div>
                        <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-full">
                            <svg class="w-6 h-6 text-yellow-500 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dashboard-card-bg rounded-lg shadow-sm p-4 border border-dashboard-border dark:border-dashboard-border">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-dashboard-text-secondary text-sm">Accepted</p>
                            <h3 id="accepted-count" class="text-2xl font-bold">0</h3>
                        </div>
                        <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full">
                            <svg class="w-6 h-6 text-green-500 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dashboard-card-bg rounded-lg shadow-sm p-4 border border-dashboard-border dark:border-dashboard-border">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-dashboard-text-secondary text-sm">Rejected</p>
                            <h3 id="rejected-count" class="text-2xl font-bold">0</h3>
                        </div>
                        <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-full">
                            <svg class="w-6 h-6 text-red-500 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status filters and search -->
            <div class="bg-white dark:bg-dashboard-card-bg rounded-lg shadow-sm p-4 mb-6 border border-dashboard-border dark:border-dashboard-border">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-2">
                    <h2 class="text-lg font-semibold">Application Filters</h2>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search applications..." 
                               class="w-full sm:w-64 pl-10 pr-4 py-2 rounded-lg border border-dashboard-border dark:border-dashboard-border bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-primary">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-4">
                    <button class="status-filter active bg-white dark:bg-dashboard-card-bg text-dashboard-text border border-dashboard-border dark:border-dashboard-border rounded-lg px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition" data-status="all">
                        All
                    </button>
                    <button class="status-filter bg-white dark:bg-dashboard-card-bg text-yellow-500 border border-yellow-200 dark:border-yellow-800/50 rounded-lg px-4 py-2 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition" data-status="pending">
                        Pending
                    </button>
                    <button class="status-filter bg-white dark:bg-dashboard-card-bg text-blue-500 border border-blue-200 dark:border-blue-800/50 rounded-lg px-4 py-2 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition" data-status="reviewed">
                        Reviewed
                    </button>
                    <button class="status-filter bg-white dark:bg-dashboard-card-bg text-purple-500 border border-purple-200 dark:border-purple-800/50 rounded-lg px-4 py-2 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition" data-status="shortlisted">
                        Shortlisted
                    </button>
                    <button class="status-filter bg-white dark:bg-dashboard-card-bg text-green-500 border border-green-200 dark:border-green-800/50 rounded-lg px-4 py-2 hover:bg-green-50 dark:hover:bg-green-900/20 transition" data-status="accepted">
                        Accepted
                    </button>
                    <button class="status-filter bg-white dark:bg-dashboard-card-bg text-red-500 border border-red-200 dark:border-red-800/50 rounded-lg px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition" data-status="rejected">
                        Rejected
                    </button>
                </div>
            </div>
            
            <!-- Loading state -->
            <div id="loading-state" class="py-12 flex justify-center items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-theme-primary"></div>
            </div>
            
            <!-- Error state -->
            <div id="error-state" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/30 text-red-800 dark:text-red-300 rounded-lg p-4 mb-6">
                <div class="flex">
                    <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <p class="font-medium">Error loading applications</p>
                        <p class="text-sm mt-1" id="error-message">Please try refreshing the page or check back later.</p>
                    </div>
                </div>
            </div>
            
            <!-- Empty state -->
            <div id="empty-state" class="hidden py-12 text-center">
                <div class="mx-auto w-24 h-24 mb-4 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-medium">No applications yet</h3>
                <p class="text-dashboard-text-secondary mt-2 max-w-md mx-auto">You haven't applied to any job offers yet. Browse available job offers to start your applications.</p>
                <a href="job-offers.html" class="inline-flex items-center mt-4 bg-theme-primary hover:bg-theme-primary-hover text-white px-4 py-2 rounded-lg transition">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Browse Job Offers
                </a>
            </div>
            
            <!-- No results for filter -->
            <div id="no-results" class="hidden py-8 text-center">
                <div class="mx-auto w-16 h-16 mb-4 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium">No matching applications</h3>
                <p class="text-dashboard-text-secondary mt-1">Try adjusting your search criteria or filters</p>
                <button id="reset-filters" class="mt-3 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-dashboard-text rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    Reset Filters
                </button>
            </div>
            
            <!-- Applications list -->
            <div id="applications-list" class="space-y-4 hidden">
                <!-- Applications will be dynamically inserted here -->
            </div>
            
            <!-- Application details modal -->
            <div id="application-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
                <div id="application-modal-backdrop" class="absolute inset-0 bg-black opacity-30"></div>
                <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 transform transition-all">
                    <div class="p-6">
                        <button id="application-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        
                        <h2 id="application-title" class="text-2xl font-bold mb-2">Job Title</h2>
                        <p id="application-company" class="text-dashboard-text-secondary mb-6">Company Name</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h3 class="text-sm font-medium text-dashboard-text-secondary mb-1">Application Status</h3>
                                <div class="flex items-center">
                                    <span id="status-dot" class="inline-block w-3 h-3 rounded-full mr-2"></span>
                                    <span id="application-status" class="font-medium">Pending</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-sm font-medium text-dashboard-text-secondary mb-1">Application Date</h3>
                                <p id="application-date" class="font-medium">October 1, 2023</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">Cover Letter</h3>
                            <div id="application-cover-letter" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-dashboard-text">
                                Cover letter content will appear here.
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">Resume</h3>
                            <div class="flex items-center">
                                <svg class="w-6 h-6 text-dashboard-text-secondary mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <a id="application-resume" href="#" class="text-theme-primary hover:underline">View Resume</a>
                            </div>
                        </div>
                        
                        <div id="application-notes-section" class="mb-6">
                            <h3 class="text-lg font-semibold mb-2">Employer Notes</h3>
                            <div id="application-notes" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg italic text-dashboard-text">
                                No notes from the employer yet.
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button id="withdraw-application" class="bg-red-600 text-white rounded-lg px-4 py-2 font-medium hover:bg-red-700 transition">
                                Withdraw Application
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer will be loaded here -->
    <div id="footer-placeholder"></div>

    <script src="../js/main.js"></script>
    <script src="../js/components.js"></script>
    <script src="../js/models.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const applicationsList = document.getElementById('applications-list');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorMessage = document.getElementById('error-message');
            const emptyState = document.getElementById('empty-state');
            const noResults = document.getElementById('no-results');
            const resetFiltersBtn = document.getElementById('reset-filters');
            const searchInput = document.getElementById('search-input');
            const statusFilters = document.querySelectorAll('.status-filter');
            
            // Stats elements
            const totalCount = document.getElementById('total-count');
            const progressCount = document.getElementById('progress-count');
            const acceptedCount = document.getElementById('accepted-count');
            const rejectedCount = document.getElementById('rejected-count');
            
            // Modal elements
            const applicationModal = document.getElementById('application-modal');
            const applicationModalClose = document.getElementById('application-modal-close');
            const applicationModalBackdrop = document.getElementById('application-modal-backdrop');
            const applicationTitle = document.getElementById('application-title');
            const applicationCompany = document.getElementById('application-company');
            const applicationStatus = document.getElementById('application-status');
            const statusDot = document.getElementById('status-dot');
            const applicationDate = document.getElementById('application-date');
            const applicationCoverLetter = document.getElementById('application-cover-letter');
            const applicationResume = document.getElementById('application-resume');
            const applicationNotes = document.getElementById('application-notes');
            const applicationNotesSection = document.getElementById('application-notes-section');
            const withdrawApplication = document.getElementById('withdraw-application');
            
            // State variables
            let applications = [];
            let filteredApplications = [];
            let currentFilter = 'all';
            let searchQuery = '';
            
            // Initialize
            loadApplications();
            
            // Add event listeners
            searchInput.addEventListener('input', function() {
                searchQuery = this.value.toLowerCase();
                filterApplications();
            });
            
            statusFilters.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active filter button
                    statusFilters.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Apply filter
                    currentFilter = this.getAttribute('data-status');
                    filterApplications();
                });
            });
            
            resetFiltersBtn.addEventListener('click', function() {
                // Reset search and filters
                searchInput.value = '';
                searchQuery = '';
                currentFilter = 'all';
                
                // Update UI
                statusFilters.forEach(button => {
                    button.classList.remove('active');
                    if (button.getAttribute('data-status') === 'all') {
                        button.classList.add('active');
                    }
                });
                
                // Apply filters
                filterApplications();
            });
            
            // Modal events
            applicationModalClose.addEventListener('click', closeModal);
            applicationModalBackdrop.addEventListener('click', closeModal);
            
            withdrawApplication.addEventListener('click', function() {
                const applicationId = this.getAttribute('data-id');
                withdrawApplicationById(applicationId);
            });
            
            // Fetch applications from server
            function loadApplications() {
                applicationsList.classList.add('hidden');
                loadingState.classList.remove('hidden');
                errorState.classList.add('hidden');
                emptyState.classList.add('hidden');
                noResults.classList.add('hidden');
                
                fetch('../api/job-applications.php')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.message || 'Unknown error occurred');
                        }
                        
                        applications = data.applications || [];
                        updateStatistics();
                        filterApplications();
                        
                        loadingState.classList.add('hidden');
                        
                        if (applications.length === 0) {
                            emptyState.classList.remove('hidden');
                        } else {
                            applicationsList.classList.remove('hidden');
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching applications:', err);
                        loadingState.classList.add('hidden');
                        errorState.classList.remove('hidden');
                        errorMessage.textContent = err.message || 'An error occurred while loading your applications.';
                    });
            }
            
            // Filter applications based on search and status filter
            function filterApplications() {
                // Apply filters
                filteredApplications = applications.filter(app => {
                    // Filter by status
                    const statusMatch = currentFilter === 'all' || app.status === currentFilter;
                    
                    // Filter by search query
                    const searchMatch = !searchQuery || 
                                       app.job_title.toLowerCase().includes(searchQuery) || 
                                       app.organization_name.toLowerCase().includes(searchQuery);
                    
                    return statusMatch && searchMatch;
                });
                
                // Update UI based on filtered results
                if (filteredApplications.length === 0 && applications.length > 0) {
                    applicationsList.classList.add('hidden');
                    noResults.classList.remove('hidden');
                } else if (applications.length === 0) {
                    applicationsList.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    noResults.classList.add('hidden');
                } else {
                    applicationsList.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                    noResults.classList.add('hidden');
                    displayApplications();
                }
            }
            
            // Display filtered applications in the UI
            function displayApplications() {
                // Clear previous items
                applicationsList.innerHTML = '';
                
                filteredApplications.forEach(app => {
                    const appItem = createApplicationItem(app);
                    applicationsList.appendChild(appItem);
                });
            }
            
            // Create application list item
            function createApplicationItem(app) {
                const appDate = new Date(app.application_date);
                const formattedDate = new Intl.DateTimeFormat('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }).format(appDate);
                
                const statusColors = {
                    'pending': 'bg-yellow-500',
                    'reviewed': 'bg-blue-500',
                    'shortlisted': 'bg-purple-500',
                    'accepted': 'bg-green-500',
                    'rejected': 'bg-red-500'
                };
                
                const statusLabels = {
                    'pending': 'Pending',
                    'reviewed': 'Reviewed',
                    'shortlisted': 'Shortlisted',
                    'accepted': 'Accepted',
                    'rejected': 'Rejected'
                };
                
                const item = document.createElement('div');
                item.className = 'bg-white dark:bg-dashboard-card-bg border border-dashboard-border dark:border-dashboard-border rounded-lg shadow-sm hover:shadow-md transition';
                item.innerHTML = `
                    <div class="p-4 sm:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center">
                                    <span class="w-3 h-3 rounded-full ${statusColors[app.status] || 'bg-gray-500'} mr-2"></span>
                                    <span class="text-sm">${statusLabels[app.status] || 'Unknown'}</span>
                                </div>
                                <h2 class="text-lg font-semibold mt-1">${app.job_title}</h2>
                                <p class="text-dashboard-text-secondary">${app.organization_name}</p>
                                <p class="text-dashboard-text-secondary text-sm mt-1">Applied on ${formattedDate}</p>
                            </div>
                            <div>
                                <button class="view-details-btn bg-theme-primary text-white rounded-lg px-4 py-2 text-sm hover:bg-theme-primary-hover transition" data-id="${app.application_id}">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listener to the view details button
                item.querySelector('.view-details-btn').addEventListener('click', function() {
                    const appId = this.getAttribute('data-id');
                    showApplicationDetails(getApplicationById(appId));
                });
                
                return item;
            }
            
            // Get application by ID
            function getApplicationById(id) {
                return applications.find(app => app.application_id == id);
            }
            
            // Show application details in modal
            function showApplicationDetails(app) {
                if (!app) return;
                
                const appDate = new Date(app.application_date);
                const formattedDate = new Intl.DateTimeFormat('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }).format(appDate);
                
                const statusColors = {
                    'pending': 'bg-yellow-500',
                    'reviewed': 'bg-blue-500',
                    'shortlisted': 'bg-purple-500',
                    'accepted': 'bg-green-500',
                    'rejected': 'bg-red-500'
                };
                
                const statusLabels = {
                    'pending': 'Pending',
                    'reviewed': 'Reviewed',
                    'shortlisted': 'Shortlisted',
                    'accepted': 'Accepted',
                    'rejected': 'Rejected'
                };
                
                applicationTitle.textContent = app.job_title;
                applicationCompany.textContent = app.organization_name;
                applicationStatus.textContent = statusLabels[app.status] || 'Unknown';
                statusDot.className = `inline-block w-3 h-3 rounded-full mr-2 ${statusColors[app.status] || 'bg-gray-500'}`;
                applicationDate.textContent = formattedDate;
                applicationCoverLetter.textContent = app.cover_letter || 'No cover letter provided.';
                
                // Set resume link if available
                if (app.resume_path) {
                    applicationResume.href = '../' + app.resume_path;
                    applicationResume.classList.remove('hidden');
                    applicationResume.parentElement.classList.remove('hidden');
                } else {
                    applicationResume.parentElement.classList.add('hidden');
                }
                
                // Set notes if available
                if (app.notes) {
                    applicationNotes.textContent = app.notes;
                    applicationNotesSection.classList.remove('hidden');
                } else {
                    applicationNotes.textContent = 'No notes from the employer yet.';
                    if (app.status === 'pending') {
                        applicationNotesSection.classList.add('hidden');
                    } else {
                        applicationNotesSection.classList.remove('hidden');
                    }
                }
                
                // Set withdraw button data
                withdrawApplication.setAttribute('data-id', app.application_id);
                
                // Only allow withdrawal if application is pending
                if (app.status === 'pending') {
                    withdrawApplication.classList.remove('hidden');
                } else {
                    withdrawApplication.classList.add('hidden');
                }
                
                applicationModal.classList.remove('hidden');
            }
            
            // Close application details modal
            function closeModal() {
                applicationModal.classList.add('hidden');
            }
            
            // Withdraw application
            function withdrawApplicationById(applicationId) {
                if (!applicationId) return;
                
                // Show a confirmation modal using the existing models.js
                if (typeof showConfirmModal === 'function') {
                    showConfirmModal(
                        'Withdraw Application', 
                        'Are you sure you want to withdraw your application? This action cannot be undone.',
                        () => {
                            // User confirmed, proceed with withdrawal
                            performWithdrawal(applicationId);
                        }
                    );
                } else {
                    // Fallback if the showConfirmModal function is not available
                    if (confirm('Are you sure you want to withdraw your application? This action cannot be undone.')) {
                        performWithdrawal(applicationId);
                    }
                }
            }
            
            // Perform the actual withdrawal
            function performWithdrawal(applicationId) {
                fetch(`../api/job-applications.php?action=withdraw&id=${applicationId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close the modal
                        closeModal();
                        
                        // Show success message
                        if (typeof showSuccessModal === 'function') {
                            showSuccessModal('Application Withdrawn', data.message);
                        } else {
                            alert('Application successfully withdrawn.');
                        }
                        
                        // Reload applications
                        loadApplications();
                    } else {
                        if (typeof showErrorModal === 'function') {
                            showErrorModal('Error', data.message || 'Failed to withdraw application.');
                        } else {
                            alert('Error: ' + (data.message || 'Failed to withdraw application.'));
                        }
                    }
                })
                .catch(error => {
                    console.error('Error withdrawing application:', error);
                    if (typeof showErrorModal === 'function') {
                        showErrorModal('Error', 'An unexpected error occurred. Please try again later.');
                    } else {
                        alert('An unexpected error occurred. Please try again later.');
                    }
                });
            }
            
            // Update statistics
            function updateStatistics() {
                const total = applications.length;
                const inProgress = applications.filter(app => ['pending', 'reviewed', 'shortlisted'].includes(app.status)).length;
                const accepted = applications.filter(app => app.status === 'accepted').length;
                const rejected = applications.filter(app => app.status === 'rejected').length;
                
                totalCount.textContent = total;
                progressCount.textContent = inProgress;
                acceptedCount.textContent = accepted;
                rejectedCount.textContent = rejected;
            }
        });
    </script>
        <script>
      // Ensure DOM is fully loaded before loading the AI assistant
      document.addEventListener("DOMContentLoaded", function () {
        // Wait a short moment to ensure all other DOM operations are complete
        setTimeout(function () {
          // Create and add the script element
          const script = document.createElement("script");
          script.src = "../js/ai-assistant.js";
          document.body.appendChild(script);
        }, 500);
      });
    </script>
</body>
</html>