<section data-auth-required="true" data-roles="admin" class="relative min-h-screen pt-16 bg-white dark:bg-gray-900">
  <!-- Breadcrumbs -->
  <div class="flex items-center text-sm mb-6">
    <a href="dashboard.html" class="text-gray-500 dark:text-gray-400 hover:text-primary nav-link">Home</a>
    <div class="w-4 h-4 flex items-center justify-center mx-1 text-gray-500 dark:text-gray-400"><i class="ri-arrow-right-s-line"></i></div>
    <a href="events.html" class="text-gray-500 dark:text-gray-400 hover:text-primary nav-link">Events</a>
    <div class="w-4 h-4 flex items-center justify-center mx-1 text-gray-500 dark:text-gray-400"><i class="ri-arrow-right-s-line"></i></div>
    <span class="text-gray-700 dark:text-gray-300" id="eventFormBreadcrumbTitle">Create New Event</span>
  </div>

  <!-- Page Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
    <h1 class="text-2xl font-bold" id="eventFormPageTitle">Create New Event</h1>
  </div>

  <!-- Form Messages -->
  <div id="formMessages" class="mb-4"></div>

  <div class="card p-6 md:p-8 w-full max-w-7xl mx-auto">
    <form id="eventForm" enctype="multipart/form-data">
      <input type="hidden" id="eventId" name="eventId">
      <input type="hidden" name="action" id="formAction" value="create">

      <!-- Title & Type -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Event Title</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="Enter event title"
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
            maxlength="100"
          >
        </div>
        <div>
          <label for="event_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Event Type</label>
          <div class="select-wrapper">
            <select
              id="event_type"
              name="event_type"
              required
              class="form-select w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base bg-white dark:bg-gray-800"
            >
              <option value="">Select Event Type</option>
              <option value="workshop">Workshop</option>
              <option value="conference">Conference</option>
              <option value="fair">Fair</option>
              <option value="webinar">Webinar</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="mt-6">
        <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
        <textarea
          id="description"
          name="description"
          rows="5"
          required
          maxlength="1000"
          placeholder="Describe the event..."
          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base resize-none"
        ></textarea>
      </div>

      <!-- Dates and Times -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5 mt-6">
        <div>
          <label for="start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Start Date</label>
          <input
            type="date"
            id="start_date"
            name="start_date"
            required
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
          >
        </div>
        <div>
          <label for="start_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Start Time</label>
          <input
            type="time"
            id="start_time"
            name="start_time"
            required
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
          >
        </div>
        <div>
          <label for="end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">End Date</label>
          <input
            type="date"
            id="end_date"
            name="end_date"
            required
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
          >
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5 mt-5">
        <div>
          <label for="end_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">End Time</label>
          <input
            type="time"
            id="end_time"
            name="end_time"
            required
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
          >
        </div>
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Location</label>
          <input
            type="text"
            id="location"
            name="location"
            required
            maxlength="150"
            placeholder="Event location"
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
          >
        </div>
        <div>
          <label for="max_capacity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Maximum Capacity</label>
          <input
            type="number"
            id="max_capacity"
            name="max_capacity"
            min="0"
            placeholder="0 for unlimited"
            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base"
          >
        </div>
      </div>

      <!-- Organizer and Approval -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mt-6">
        <div>
          <label for="organizer_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Organizer</label>
          <div class="select-wrapper">
            <select
              id="organizer_id"
              name="organizer_id"
              class="form-select w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base bg-white dark:bg-gray-800"
            >
              <option value="">Select Organizer</option>
              <!-- This will be dynamically populated -->
            </select>
          </div>
        </div>
        <div>
          <label for="requires_approval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Requires Approval</label>
          <div class="select-wrapper">
            <select
              id="requires_approval"
              name="requires_approval"
              class="form-select w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:border-primary text-base bg-white dark:bg-gray-800"
            >
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Thumbnail -->
      <div class="mt-6">
        <label for="thumbnail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Event Thumbnail</label>
        <input
          type="file"
          id="thumbnail"
          name="thumbnail"
          accept="image/png, image/jpeg, image/gif"
          class="form-file-input w-full text-sm border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-4"
        >
        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">PNG, JPG, GIF up to 2MB. Current image (if any) will be replaced.</p>
        <img id="currentThumbnail" src="#" alt="Current Event Thumbnail" class="mt-3 max-h-40 rounded-lg hidden object-cover">
      </div>

      <!-- Actions -->
      <div class="mt-8 pt-5 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
        <button type="button" id="cancelFormBtn" class="px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
          Cancel
        </button>
        <button type="submit" id="submitEventBtn" class="px-5 py-2.5 text-sm font-medium text-white bg-primary hover:bg-primary-dark rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:focus:ring-offset-gray-900">
          Create Event
        </button>
      </div>
    </form>
  </div>
</section>
<script>
(function() {
    console.log("Create/Edit Event view specific JavaScript executed.");

    const eventForm = document.getElementById('eventForm');
    const eventFormPageTitle = document.getElementById('eventFormPageTitle');
    const eventFormBreadcrumbTitle = document.getElementById('eventFormBreadcrumbTitle');
    const submitEventBtn = document.getElementById('submitEventBtn');
    const eventIdInput = document.getElementById('eventId');
    const formActionInput = document.getElementById('formAction');
    const formMessages = document.getElementById('formMessages');
    const currentThumbnail = document.getElementById('currentThumbnail');
    const thumbnailUploadInput = document.getElementById('thumbnail');
    const cancelFormBtn = document.getElementById('cancelFormBtn');

    let isEditMode = false;
    let currentEditId = null;

    function displayMessage(type, message) {
        formMessages.innerHTML = ''; // Clear previous messages
        const alertClasses = type === 'success' 
            ? 'bg-green-100 border-green-400 text-green-700 dark:bg-green-700 dark:text-green-100 dark:border-green-600' 
            : 'bg-red-100 border-red-400 text-red-700 dark:bg-red-700 dark:text-red-100 dark:border-red-600';
        const icon = type === 'success' ? '<i class="ri-check-line mr-2"></i>' : '<i class="ri-error-warning-line mr-2"></i>';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `border-l-4 p-4 rounded-md ${alertClasses}`;
        messageDiv.setAttribute('role', 'alert');
        messageDiv.innerHTML = `<p class="font-bold">${type === 'success' ? 'Success' : 'Error'}</p><p>${icon}${message}</p>`;
        formMessages.appendChild(messageDiv);
        formMessages.scrollIntoView({ behavior: 'smooth' });
    }

    async function loadEventData(id) {
        try {
            const response = await fetch(`/iteam-university-website/admin/api/events.php?id=${id}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
                throw new Error(errorData.message || `Failed to fetch event data for ID ${id}.`);
            }
            const result = await response.json();
            if (result.success && result.event) {
                populateForm(result.event);
            } else {
                throw new Error(result.message || "Event data not found.");
            }
        } catch (error) {
            console.error("Error loading event data:", error);
            displayMessage('error', `Could not load event data: ${error.message}`);
            // Optionally redirect or disable form
        }
    }

    function populateForm(event) {
        document.getElementById('title').value = event.title || '';
        document.getElementById('event_type').value = event.event_type || '';
        document.getElementById('description').value = event.description || '';
        
        if (event.start_date) {
            const startDateTime = new Date(event.start_date);
            document.getElementById('start_date').value = startDateTime.toISOString().split('T')[0];
            document.getElementById('start_time').value = startDateTime.toTimeString().substring(0, 5);
        }
        
        if (event.end_date) {
            const endDateTime = new Date(event.end_date);
            document.getElementById('end_date').value = endDateTime.toISOString().split('T')[0];
            document.getElementById('end_time').value = endDateTime.toTimeString().substring(0, 5);
        }
        
        document.getElementById('location').value = event.location || '';
        document.getElementById('max_capacity').value = event.max_capacity || '';
        document.getElementById('organizer_id').value = event.organizer_id || '';
        document.getElementById('requires_approval').value = event.requires_approval ? '1' : '0';

        if (event.thumbnail_url) {
            document.getElementById('currentThumbnail').src = `/iteam-university-website/admin/${event.thumbnail_url}`;
            document.getElementById('currentThumbnail').classList.remove('hidden');
        } else {
            document.getElementById('currentThumbnail').classList.add('hidden');
        }
    }
    
    function setupFormForEditMode(editId) {
        isEditMode = true;
        currentEditId = editId;
        eventFormPageTitle.textContent = 'Edit Event';
        eventFormBreadcrumbTitle.textContent = 'Edit Event';
        submitEventBtn.innerHTML = '<i class="ri-save-line mr-2"></i> Save Changes';
        eventIdInput.value = editId;
        formActionInput.value = 'update';
        loadEventData(editId);
    }

    // Check for edit_id in hash
    const hashString = window.location.hash.substring(1); // e.g., "create-event.html?edit_id=3"
    if (hashString) {
        const parts = hashString.split('?');
        if (parts.length > 1) {
            const paramsString = parts[1]; // "edit_id=3"
            try {
                const urlParams = new URLSearchParams(paramsString);
                const editIdParam = urlParams.get('edit_id');
                if (editIdParam) {
                    setupFormForEditMode(editIdParam);
                }
            } catch (e) {
                console.error("Error parsing query parameters from hash for edit mode:", e);
            }
        }
    }

    if (thumbnailUploadInput) {
        thumbnailUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentThumbnail.src = event.target.result;
                    currentThumbnail.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        });
    }
    
    if (cancelFormBtn) {
        cancelFormBtn.addEventListener('click', () => {
            if (isEditMode && currentEditId) {
                if (typeof loadView === 'function') loadView(`event-details.html?id=${currentEditId}`);
                else window.location.hash = `event-details.html?id=${currentEditId}`;
            } else {
                 if (typeof loadView === 'function') loadView('events.html');
                 else window.location.hash = 'events.html';
            }
        });
    }


    if (eventForm) {
        eventForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            formMessages.innerHTML = '';
            
            // Form validation
            const startDate = document.getElementById('start_date').value;
            const startTime = document.getElementById('start_time').value;
            const endDate = document.getElementById('end_date').value;
            const endTime = document.getElementById('end_time').value;
            
            // Create Date objects for comparison
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);
            
            if (endDateTime <= startDateTime) {
                displayMessage('error', 'End date/time must be after start date/time');
                return;
            }
            
            const originalButtonText = submitEventBtn.innerHTML;
            submitEventBtn.disabled = true;
            submitEventBtn.innerHTML = `<i class="ri-loader-4-line ri-spin mr-2"></i> ${isEditMode ? 'Saving...' : 'Creating...'}`;

            // Combine date and time fields
            const formData = new FormData(eventForm);
            
            // Remove individual date/time fields and add combined datetime fields
            formData.delete('start_date');
            formData.delete('start_time');
            formData.delete('end_date');
            formData.delete('end_time');
            
            formData.append('start_date', `${startDate} ${startTime}:00`);
            formData.append('end_date', `${endDate} ${endTime}:00`);
            
            // Rest of your form submission code...
            let apiUrl = '/iteam-university-website/admin/api/events.php';
            let method = 'POST'; // Always POST, action field in FormData differentiates create/update

            try {
                const response = await fetch(apiUrl, {
                    method: method,
                    body: formData 
                    // Headers are not explicitly set to 'multipart/form-data';
                    // the browser will set it automatically when FormData includes a file.
                });

                const result = await response.json();

                if (result.success) {
                    displayMessage('success', result.message || `Event ${isEditMode ? 'updated' : 'created'} successfully!`);
                    setTimeout(() => {
                        if (typeof loadView === 'function') {
                            // If creating, result might contain new event_id. If editing, use currentEditId.
                            const targetEventId = result.event_id || currentEditId;
                            if (targetEventId) {
                                loadView(`event-details.html?id=${targetEventId}`);
                            } else {
                                loadView('events.html');
                            }
                        } else {
                             window.location.hash = 'events.html'; // Fallback
                        }
                    }, 1500);
                    if (!isEditMode) eventForm.reset(); // Reset form on successful creation
                } else {
                    displayMessage('error', result.message || `Failed to ${isEditMode ? 'update' : 'create'} event.`);
                }
            } catch (error) {
                console.error('Form submission error:', error);
                displayMessage('error', `An unexpected error occurred: ${error.message}`);
            } finally {
                submitEventBtn.disabled = false;
                submitEventBtn.innerHTML = originalButtonText;
            }
        });
    }

    // Add this function to load organizations for the dropdown
    async function loadOrganizers() {
        try {
            const response = await fetch('/iteam-university-website/admin/api/organizations.php');
            if (!response.ok) throw new Error('Failed to fetch organizations');
            const data = await response.json();
            
            if (data.success && data.organizations) {
                const organizerSelect = document.getElementById('organizer_id');
                organizerSelect.innerHTML = '<option value="">Select Organizer</option>';
                
                data.organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.organization_id;
                    option.textContent = org.name;
                    organizerSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Error loading organizers:", error);
        }
    }

    // Function to set up custom date-time pickers if needed
    function enhanceFormControls() {
        // Add any form control enhancements here
        
        // Date validation - ensure end date is not before start date
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        endDateInput.addEventListener('change', function() {
            if (startDateInput.value && this.value) {
                if (this.value < startDateInput.value) {
                    displayMessage('error', 'End date cannot be before start date');
                    this.value = startDateInput.value;
                }
            }
        });
        
        // Enhance select inputs with custom styling
        const selects = document.querySelectorAll('.form-select');
        selects.forEach(select => {
            select.addEventListener('focus', function() {
                this.parentElement.classList.add('ring-1', 'ring-primary');
            });
            
            select.addEventListener('blur', function() {
                this.parentElement.classList.remove('ring-1', 'ring-primary');
            });
        });
    }

    // Call this function when document is loaded
    document.addEventListener('DOMContentLoaded', function() {
        loadOrganizers();
        enhanceFormControls();
    });
})();
</script>

<style>
.form-input {
  @apply w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:border-primary focus:ring-1 focus:ring-primary shadow-sm px-4 py-2.5;
}

.form-select {
  @apply w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:border-primary focus:ring-1 focus:ring-primary shadow-sm px-4 py-2.5 appearance-none;
}

/* Custom select arrow styling */
.select-wrapper {
  @apply relative;
}

.select-wrapper:after {
  content: '';
  @apply absolute right-4 top-1/2 transform -translate-y-1/2 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-gray-400 dark:border-t-gray-300 pointer-events-none;
}

.form-file-input {
  @apply block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary-50 dark:file:bg-gray-700 file:text-primary dark:file:text-primary-300 hover:file:bg-primary-100 dark:hover:file:bg-gray-600 cursor-pointer;
}
</style>