<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - iTeam University</title>
    <base href="http://localhost/iteam-university-website/frontend/" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body style="padding-top: 0;">
    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="dashboard-sidebar active">
        <div class="sidebar-header">
          <h3><i class="fas fa-university"></i> Admin Panel</h3>
          <button class="close-sidebar"><i class="fas fa-times"></i></button>
        </div>
        <div class="sidebar-user">
          <div class="avatar" id="sidebar-avatar">
            <div class="profile-initials">AD</div>
          </div>
          <div class="user-info">
            <span class="user-name" id="sidebar-user-name">Admin User</span>
            <span class="user-role" id="sidebar-user-role">Administrator</span>
          </div>
        </div>
        <ul class="sidebar-menu">
          <li>
            <a href="dashboards/admin/overview.html" class="nav-link active" data-page="overview"
              ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="dashboards/admin/users.html" class="nav-link" data-page="users"
              ><i class="fas fa-users"></i> Manage Users</a
            >
          </li>
          <li>
            <a href="dashboards/admin/events.html" class="nav-link" data-page="events"
              ><i class="fas fa-calendar-alt"></i> Manage Events</a
            >
          </li>
          <li>
            <a href="dashboards/admin/organizations.html" class="nav-link" data-page="organizations"
              ><i class="fas fa-building"></i> Manage Organizations</a
            >
          </li>
          <li>
            <a href="dashboards/admin/reports.html" class="nav-link" data-page="reports"
              ><i class="fas fa-chart-bar"></i> Reports</a
            >
          </li>
          <li>
            <a href="dashboards/admin/settings.html" class="nav-link" data-page="settings"
              ><i class="fas fa-cog"></i> Settings</a
            >
          </li>
          <li>
            <a href="dashboards/admin/profile.html" class="nav-link" data-page="profile"
              ><i class="fas fa-user-circle"></i> Profile</a
            >
          </li>
          <li class="sidebar-divider"></li>
          <li>
            <a href="#" id="sidebar-logout-link"
              ><i class="fas fa-sign-out-alt"></i> Logout</a
            >
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <div class="dashboard-content">
        <!-- Top Navigation -->
        <nav class="dashboard-nav">
          <div class="dashboard-nav-left">
            <button class="toggle-sidebar" aria-label="Toggle Sidebar">
              <i class="fas fa-bars"></i>
            </button>
            <h2 id="page-title">Admin Dashboard</h2>
          </div>
          <div class="dashboard-nav-right">
            <div class="nav-actions">
              <button class="action-btn" aria-label="Notifications">
                <i class="fas fa-bell"></i>
                <span class="badge">3</span>
              </button>
              <button
                id="theme-switch"
                class="action-btn"
                aria-label="Toggle Theme"
              >
                <i class="fas fa-moon"></i>
              </button>
            </div>
            <div class="user-menu" id="user-menu">
              <div class="user-avatar" id="header-avatar">
                <div class="profile-initials">AD</div>
              </div>
              <div class="user-info">
                <span class="user-name" id="header-user-name">Admin User</span>
                <span class="user-role" id="header-user-role">Administrator</span>
              </div>
              <i class="fas fa-chevron-down dropdown-icon"></i>

              <div class="user-dropdown">
                <a href="dashboards/admin/profile.html" class="dropdown-item nav-link" data-page="profile">
                  <i class="fas fa-user-circle"></i> Profile
                </a>
                <a href="dashboards/admin/settings.html" class="dropdown-item nav-link" data-page="settings">
                  <i class="fas fa-cog"></i> Settings
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" id="logout-link" class="dropdown-item">
                  <i class="fas fa-sign-out-alt"></i> Logout
                </a>
              </div>
            </div>
          </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content-area">
          <!-- Dynamic content container -->
          <div id="content-container">
            <!-- Content will be loaded here dynamically -->
            <div class="loading-spinner">Loading...</div>
          </div>
        </main>
      </div>
    </div>
    <!-- Include JS files -->
    <script src="js/theme-switcher.js"></script> 
    <!-- Add page-specific JS files here -->
    <script src="js/overview.js"></script>
    <script src="js/users.js"></script>
    <script src="js/events.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/organizations.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

        

    <script>
      // DOM Elements
      const contentContainer = document.getElementById('content-container');
      const pageTitle = document.getElementById('page-title');
      const navLinks = document.querySelectorAll('.nav-link');
      
      // User information elements
      const sidebarUserName = document.getElementById('sidebar-user-name');
      const sidebarUserRole = document.getElementById('sidebar-user-role');
      const sidebarAvatar = document.getElementById('sidebar-avatar');
      const headerUserName = document.getElementById('header-user-name');
      const headerUserRole = document.getElementById('header-user-role');
      const headerAvatar = document.getElementById('header-avatar');

      // Map page names to their initialization functions
      const pageInitializers = {
        'overview': typeof initAdminOverview === 'function' ? initAdminOverview : null,
        'users': typeof initUsersPage === 'function' ? initUsersPage : null,
        'events': typeof initEventsPage === 'function' ? initEventsPage : null,
        'profile': typeof initAdminProfile === 'function' ? initAdminProfile : null,
        'organizations': typeof initOrganizationsPage === 'function' ? initOrganizationsPage : null,
        // Add other pages here as needed, e.g.:
        // 'settings': initSettingsPage, 
        // 'reports': initReportsPage,
      };

      // Fetch admin user information and update UI
      function fetchAdminUserInfo() {
        fetch('../backend/api/admin/adminlogin.php?check=1')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.user) {
              // Update user names
              const userName = data.user.name || 'Admin User';
              sidebarUserName.textContent = userName;
              headerUserName.textContent = userName;
              
              // User role is always Administrator for admin users
              const userRole = 'Administrator';
              sidebarUserRole.textContent = userRole;
              headerUserRole.textContent = userRole;
              
              // Update avatars - either profile picture or initials
              updateAvatars(data.user);
              
              // Store user data in session storage for other parts of the app
              sessionStorage.setItem('adminUser', JSON.stringify(data.user));
            } else {
              // Not logged in - redirect to admin login
              console.log('Admin not authenticated. Redirecting to login page.');
              window.location.href = 'auth/admin-login.html';
            }
          })
          .catch(error => {
            console.error('Error fetching admin info:', error);
          });
      }
      
      // Helper function to update user avatars
      function updateAvatars(user) {
        // Generate user's initials from name
        const initials = user.name.split(' ')
          .map(name => name.charAt(0))
          .join('')
          .toUpperCase()
          .substring(0, 2);
        
        // Update both the sidebar and header avatars
        if (user.profile_picture) {
          // Use profile picture if available
          sidebarAvatar.innerHTML = `<img src="${user.profile_picture}" alt="Profile" class="profile-pic">`;
          headerAvatar.innerHTML = `<img src="${user.profile_picture}" alt="Profile" class="profile-pic">`;
        } else {
          // Use initials if no profile picture
          sidebarAvatar.innerHTML = `<div class="profile-initials">${initials}</div>`;
          headerAvatar.innerHTML = `<div class="profile-initials">${initials}</div>`;
        }
      }

      // Get the current page from URL or default to overview
      function getCurrentPage() {
        // First try to get it from the URL path
        const currentPath = window.location.pathname;
        const pathSegments = currentPath.split('/');
        let htmlFileName = pathSegments[pathSegments.length - 1];
        
        // If URL contains hash, let's check if it has page info
        if (window.location.hash) {
          const hashPage = window.location.hash.substring(1);
          if (hashPage) {
            return hashPage;
          }
        }
        
        // Otherwise use the path
        let pageName = htmlFileName.replace('.html', '');
        
        // Handle case where URL might be the dashboard itself
        if (pageName === 'dashboard' || pageName === '') {
          return 'overview';
        }
        
        return pageName || 'overview';
      }

      // Get URL for a specific page
      function getPageUrl(pageName) {
        return `dashboards/admin/${pageName}.html`;
      }

      // Load content on page load including refresh
      function loadInitialContent() {
        const pageName = getCurrentPage();
        const url = getPageUrl(pageName);
        
        // Update active nav link
        navLinks.forEach(link => {
          if (link.dataset.page === pageName) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
        
        // Load the content
        loadContent(url, pageName);
      }

      // Function to load content
      function loadContent(url, pageName) {
        // Show loading state
        contentContainer.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        
        // Update active nav link
        navLinks.forEach(link => {
          if (link.dataset.page === pageName) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
        
        // Update page title based on the page being loaded
        updatePageTitle(pageName);
        
        // Fetch and insert content
        fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to load page: ${response.status} ${response.statusText}`);
            }
            return response.text();
          })
          .then(html => {
            // Parse the HTML to extract just the content we need
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const content = doc.querySelector('#page-content');
            
            if (!content) {
              throw new Error('Could not find content in the loaded page. Make sure your pages have a #page-content element.');
            }
            
            // Insert the content
            contentContainer.innerHTML = '';
            contentContainer.appendChild(content);
            
            // Call the specific initialization function for the loaded page
            if (pageInitializers[pageName]) {
              console.log(`Initializing page: ${pageName}`);
              try {
                pageInitializers[pageName]();
              } catch (initError) {
                console.error(`Error initializing page ${pageName}:`, initError);
                contentContainer.innerHTML += `<div class="error-message">Error initializing page scripts.</div>`;
              }
            } else {
              console.warn(`No initializer found for page: ${pageName}`);
            }
            
            // Close mobile sidebar after navigation
            if (window.innerWidth < 992) {
              document.querySelector('.dashboard-sidebar').classList.remove('active');
              document.querySelector('.dashboard-content').classList.add('full-width');
            }
            
            console.log(`Successfully loaded: ${url}`);
          })
          .catch(error => {
            contentContainer.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error Loading Content</h3>
                <p>${error.message}</p>
                <button class="btn" onclick="window.location.reload()">Retry</button>
              </div>
            `;
            console.error('Error loading page:', error);
          });
      }
      
      // Function to update page title
      function updatePageTitle(pageName) {
        let title = 'Admin Dashboard';
        
        switch(pageName) {
          case 'users':
            title = 'Manage Users';
            break;
          case 'events':
            title = 'Manage Events';
            break;
          case 'organizations':
            title = 'Manage Organizations';
            break;
          case 'reports':
            title = 'Reports';
            break;
          case 'settings':
            title = 'Settings';
            break;
          case 'profile':
            title = 'Profile';
            break;
          default:
            title = 'Admin Dashboard';
        }
        
        pageTitle.textContent = title;
        document.title = `${title} - iTeam University`;
      }
      
      // Add event listeners to all navigation links
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const url = this.getAttribute('href');
          const page = this.dataset.page;
          
          // Change browser URL using hash instead of pushState
          // This makes refresh work much more reliably across servers
          window.location.hash = page;
          
          // Load the content
          loadContent(url, page);
        });
      });
      
      // Handle hash change for back/forward navigation
      window.addEventListener('hashchange', function() {
        const page = window.location.hash.substring(1) || 'overview';
        const url = getPageUrl(page);
        loadContent(url, page);
      });
      
      // Fetch admin user info and load initial content when page loads
      document.addEventListener('DOMContentLoaded', function() {
        fetchAdminUserInfo();
        loadInitialContent();
      });

      // Toggle sidebar
      document
        .querySelector(".toggle-sidebar")
        .addEventListener("click", function () {
          const sidebar = document.querySelector(".dashboard-sidebar");
          const content = document.querySelector(".dashboard-content");

          sidebar.classList.toggle("active");
          content.classList.toggle("full-width");
        });

      // Close sidebar (mobile)
      document
        .querySelector(".close-sidebar")
        .addEventListener("click", function () {
          document
            .querySelector(".dashboard-sidebar")
            .classList.remove("active");
          document
            .querySelector(".dashboard-content")
            .classList.add("full-width");
        });

      // User dropdown toggle
      document
        .getElementById("user-menu")
        .addEventListener("click", function (e) {
          this.querySelector(".user-dropdown").classList.toggle("show");
          e.stopPropagation();
        });

      // Close dropdown when clicking elsewhere
      document.addEventListener("click", function () {
        const dropdown = document.querySelector(".user-dropdown");
        if (dropdown && dropdown.classList.contains("show")) {
          dropdown.classList.remove("show");
        }
      });

      // Logout functionality (both in sidebar and dropdown)
      const logoutLinks = document.querySelectorAll("#logout-link, #sidebar-logout-link");

      logoutLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          // Call the correct admin logout endpoint (within adminlogin.php)
          fetch('../backend/api/admin/adminlogin.php?logout=1') 
            .then(response => {
                // Check if response is ok and is JSON
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new TypeError("Received non-JSON response from server.");
                }
                return response.json();
            })
            .then(data => {
              console.log('Logout response:', data);
              if (data.success && data.redirect) {
                // Redirect to the URL provided by the backend
                window.location.href = data.redirect; 
              } else {
                console.error('Logout failed:', data.message || 'Unknown error');
                // Fallback redirect in case of unexpected backend response
                window.location.href = 'auth/admin-login.html'; 
              }
            })
            .catch(error => {
              console.error('Error during logout:', error);
              // Fallback redirect in case of network or other errors
              window.location.href = 'auth/admin-login.html';
            });
        });
      });

    </script>
  </body>
</html>