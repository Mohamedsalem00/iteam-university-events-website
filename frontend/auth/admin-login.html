<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Login - iTeam University</title>
    <base href="http://localhost/iteam-university-website/frontend/" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
      .admin-badge {
        display: inline-block;
        background-color: #d9534f;
        color: white;
        padding: 0.3rem 0.7rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        font-weight: 500;
      }
      
      .security-notice {
        background-color: rgba(var(--primary-color), 0.1);
        border-left: 4px solid var(--primary-color);
        padding: 1rem;
        margin: 1.5rem 0;
        border-radius: 0 4px 4px 0;
      }
      
      .security-notice h3 {
        margin-top: 0;
        color: var(--primary-color);
        font-size: 1rem;
      }
      
      .auth-subtitle {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>

    <main>
      <section class="auth-section">
        <div class="container">
          <div class="auth-container">
            <div class="auth-logo">
              <img src="assets/images/logo.png" alt="iTeam University Logo" class="logo-img">
            </div>
            
            <div class="auth-card">
              <div class="auth-header">
                <span class="admin-badge"><i class="fas fa-shield-alt"></i> Admin Portal</span>
                <h2>Administrator Login</h2>
                <p class="auth-subtitle">Access the administrative dashboard</p>
              </div>
              
              <div id="login-alert" class="alert" style="display: none;"></div>
              
              <form id="admin-login-form" class="validation-form">
                <div class="form-group">
                  <div class="input-icon-wrap">
                    <span class="input-icon"><i class="fas fa-envelope"></i></span>
                    <input type="email" id="admin-email" name="email" class="form-control with-icon" placeholder="Admin Email" required />
                  </div>
                  <div id="email-error" class="validation-error"></div>
                </div>

                <div class="form-group">
                  <div class="input-icon-wrap">
                    <span class="input-icon"><i class="fas fa-lock"></i></span>
                    <input type="password" id="admin-password" name="password" class="form-control with-icon" placeholder="Password" required />
                    <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                  <div id="password-error" class="validation-error"></div>
                </div>

                <div class="form-group compact-terms">
                  <input type="checkbox" id="remember" name="remember" />
                  <label for="remember">Remember me</label>
                </div>

                <div class="form-group">
                  <button type="submit" id="login-btn" class="btn auth-btn">
                    Secure Login
                  </button>
                </div>
              </form>
              
              <div class="security-notice">
                <h3><i class="fas fa-info-circle"></i> Security Notice</h3>
                <p>This is a secured administrative area. Unauthorized access attempts are logged and may be reported.</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="js/main.js"></script>
    <script src="js/theme-switcher.js"></script>
    <script src="js/auth-check.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Check if user is already logged in as admin using the correct endpoint
        fetch('../backend/api/admin/adminlogin.php?check=1') 
          .then(response => response.json())
          .then(data => {
            if (data.success && data.user && data.user.is_admin) { // Check for is_admin flag
              // Redirect to admin dashboard if already logged in
              window.location.href = data.user.dashboard_url || 'dashboards/admin/dashboard.html';
            }
          })
          .catch(error => console.error('Initial admin auth check error:', error));
        
        // Toggle password visibility
        const toggleButton = document.querySelector('.password-toggle');
        toggleButton.addEventListener('click', function() {
          const passwordInput = document.getElementById('admin-password');
          const icon = this.querySelector('i');
          
          if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
          } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
          }
        });
        
        // Form submission
        const form = document.getElementById('admin-login-form');
        const loginAlert = document.getElementById('login-alert');
        const loginBtn = document.getElementById('login-btn');
        
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Hide previous alerts
          loginAlert.style.display = 'none';
          
          // Reset validation errors
          document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
          
          // Show loading state
          loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
          loginBtn.disabled = true;
          
          // Get form data
          const formData = new FormData(form);
          
          // Submit login request to the correct admin endpoint
          fetch('../backend/api/admin/adminlogin.php', { 
            method: 'POST',
            body: formData
          })
          .then(response => {
            // Improved error handling: Check response status first
            if (!response.ok) {
              return response.json().then(errData => {
                 throw new Error(errData.message || `HTTP error! Status: ${response.status}`);
              }).catch(() => {
                 throw new Error(`HTTP error! Status: ${response.status}`);
              });
            }
            return response.json();
          })
          .then(data => {
            if (data.success && data.user && data.user.is_admin) { // Verify success and admin status
              // Redirect to admin dashboard
              window.location.href = data.user.dashboard_url || 'dashboards/admin/dashboard.html';
            } else {
              // Handle login failure
              loginBtn.innerHTML = 'Secure Login';
              loginBtn.disabled = false;
              
              // Show error message from API response
              loginAlert.className = 'alert alert-danger';
              loginAlert.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message || 'Authentication failed. Please check credentials.'}`;
              loginAlert.style.display = 'block';
            }
          })
          .catch(error => {
            // Handle network errors or other exceptions during fetch/processing
            console.error('Admin login submission error:', error);
            
            loginBtn.innerHTML = 'Secure Login';
            loginBtn.disabled = false;
            
            // Show a generic but informative error message
            loginAlert.className = 'alert alert-danger';
            loginAlert.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message || 'An error occurred. Please try again.'}`;
            loginAlert.style.display = 'block';
          });
        });
      });
    </script>
  </body>
</html>